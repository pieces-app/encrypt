name: Dart CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs when new commits are pushed
concurrency:
  group: dart-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: ğŸ§¹ Analyze
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        sdk: [stable]
    steps:
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4
      
      - name: ğŸ¯ Install Dart SDK
        uses: dart-lang/setup-dart@v1
        with:
          sdk: ${{ matrix.sdk }}
      
      - name: ğŸ“‹ Report version
        run: dart --version
      
      - name: ğŸ“š Install dependencies
        run: dart pub get
      
      - name: ğŸ§¹ Check formatting
        run: |
          # Line length 120 matches repo conventions
          dart format --line-length=120 --output=none --set-exit-if-changed . || echo "âš ï¸ Some files need formatting"
      
      - name: ğŸ” Analyze code
        run: |
          # Report analysis issues but don't fail on warnings (legacy codebase)
          dart analyze . || echo "âš ï¸ Analysis warnings found - review above"

  test:
    name: ğŸ§ª Test (${{ matrix.os }})
    needs: analyze
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        sdk: [stable]
    steps:
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4
      
      - name: ğŸ¯ Install Dart SDK
        uses: dart-lang/setup-dart@v1
        with:
          sdk: ${{ matrix.sdk }}
      
      - name: ğŸ“‹ Report version
        run: dart --version
      
      - name: ğŸ“š Install dependencies
        run: dart pub get
      
      - name: ğŸ§ª Run unit tests
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 10
          command: dart test --platform vm --concurrency=4

