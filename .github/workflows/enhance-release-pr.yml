name: Enhance Release PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

# Cancel in-progress runs when a new commit is pushed to the same PR
concurrency:
  group: enhance-release-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  enhance-release-pr:
    name: ü§ñ Claude AI Enhancement
    if: startsWith(github.event.pull_request.head.ref, 'release-please--')
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout PR Branch
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üè∑Ô∏è Extract Version from PR Title
        id: version
        run: |
          # Extract version using sed -E (extended regex, more portable than grep -P)
          VERSION=$(echo "${{ github.event.pull_request.title }}" | sed -E 's/.*([0-9]+\.[0-9]+\.[0-9]+).*/\1/' || echo "")
          if [ -z "$VERSION" ]; then
            echo "‚ö†Ô∏è Could not extract version from PR title"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "üì¶ Detected version: $VERSION"
          fi

      - name: ‚¨ÖÔ∏è Get Previous Version
        id: prev_version
        if: steps.version.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Determining previous version..."
          
          # Method 1: Try to get from base branch's manifest (most reliable)
          echo "üìã Checking base branch (${{ github.event.pull_request.base.ref }}) manifest..."
          BASE_MANIFEST=$(gh api repos/${{ github.repository }}/contents/.release-please-manifest.json?ref=${{ github.event.pull_request.base.ref }} 2>/dev/null | jq -r '.content' | base64 -d 2>/dev/null || echo "")
          if [ -n "$BASE_MANIFEST" ]; then
            PREV=$(echo "$BASE_MANIFEST" | jq -r '."."' 2>/dev/null || echo "")
            if [ -n "$PREV" ] && [ "$PREV" != "null" ] && [ "$PREV" != "0.0.0" ]; then
              echo "‚úÖ Found version from base branch manifest: $PREV"
              echo "prev_version=$PREV" >> $GITHUB_OUTPUT
              echo "üì¶ Previous version: $PREV"
              exit 0
            fi
          fi
          
          # Method 2: Get latest GitHub release tag
          echo "üè∑Ô∏è Checking GitHub releases..."
          LATEST_RELEASE=$(gh api repos/${{ github.repository }}/releases/latest 2>/dev/null | jq -r '.tag_name' | sed 's/^v//' || echo "")
          if [ -n "$LATEST_RELEASE" ] && [ "$LATEST_RELEASE" != "null" ]; then
            echo "‚úÖ Found version from GitHub releases: $LATEST_RELEASE"
            echo "prev_version=$LATEST_RELEASE" >> $GITHUB_OUTPUT
            echo "üì¶ Previous version: $LATEST_RELEASE"
            exit 0
          fi
          
          # Method 3: Get latest tag (even if no release exists)
          echo "üè∑Ô∏è Checking Git tags..."
          # Use sed instead of grep -oP for portability (BSD grep doesn't support -P)
          LATEST_TAG=$(git ls-remote --tags origin | sed -nE 's|.*refs/tags/v([0-9]+\.[0-9]+\.[0-9]+).*|\1|p' | sort -V | tail -1 || echo "")
          if [ -n "$LATEST_TAG" ]; then
            echo "‚úÖ Found version from Git tags: $LATEST_TAG"
            echo "prev_version=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "üì¶ Previous version: $LATEST_TAG"
            exit 0
          fi
          
          # Method 4: Fallback to PR branch manifest (might have new version, but better than 0.0.0)
          echo "üìã Checking PR branch manifest (fallback)..."
          PREV=$(jq -r '."."' .release-please-manifest.json 2>/dev/null || echo "0.0.0")
          if [ "$PREV" = "null" ] || [ -z "$PREV" ]; then
            PREV="0.0.0"
          fi
          
          # If we got the same version as proposed, try to decrement patch version
          if [ "$PREV" = "${{ steps.version.outputs.version }}" ]; then
            echo "‚ö†Ô∏è PR branch has same version as proposed, attempting to infer previous..."
            # Try to get from git log or fallback to decrementing patch
            MAJOR=$(echo "$PREV" | cut -d. -f1)
            MINOR=$(echo "$PREV" | cut -d. -f2)
            PATCH=$(echo "$PREV" | cut -d. -f3)
            if [ "$PATCH" -gt 0 ]; then
              PREV="$MAJOR.$MINOR.$((PATCH - 1))"
              echo "üìâ Decremented patch version: $PREV"
            else
              PREV="0.0.0"
            fi
          fi
          
          echo "prev_version=$PREV" >> $GITHUB_OUTPUT
          echo "üì¶ Previous version: $PREV"

      - name: ‚úÖ Check if Already Enhanced
        id: check
        if: steps.version.outputs.skip != 'true'
        run: |
          if grep -q "### üöÄ Release Highlights" CHANGELOG.md; then
            VERSION_LINE=$(grep -n "## \[${{ steps.version.outputs.version }}\]" CHANGELOG.md | head -1 | cut -d: -f1 || echo "0")
            HIGHLIGHTS_LINE=$(grep -n "### üöÄ Release Highlights" CHANGELOG.md | head -1 | cut -d: -f1 || echo "99999")
            
            if [ "$VERSION_LINE" != "0" ] && [ "$HIGHLIGHTS_LINE" -gt "$VERSION_LINE" ]; then
              NEXT_VERSION=$(grep -n "## \[" CHANGELOG.md | grep -v "^$VERSION_LINE:" | head -1 | cut -d: -f1 || echo "99999")
              if [ "$HIGHLIGHTS_LINE" -lt "${NEXT_VERSION:-99999}" ]; then
                echo "‚úÖ Already enhanced"
                echo "already_enhanced=true" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
          fi
          echo "already_enhanced=false" >> $GITHUB_OUTPUT

      - name: ü§ñ Full Release Enhancement with Claude
        if: steps.version.outputs.skip != 'true' && steps.check.outputs.already_enhanced != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY_GLOBAL_CLOUD_RUNTIME }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PROPOSED_VERSION: ${{ steps.version.outputs.version }}
            PREVIOUS_VERSION: ${{ steps.prev_version.outputs.prev_version }}
            PR_BRANCH: ${{ github.event.pull_request.head.ref }}
            PR_NUMBER: ${{ github.event.pull_request.number }}
            
            # ü§ñ CLAUDE CODE: RELEASE MANAGER FOR pieces-app/encrypt
            
            ## Project Context
            
            **Encrypt** is a **Dart cryptography library** providing high-level APIs over PointyCastle for two-way cryptography.
            
            Key characteristics:
            - **Cryptography**: AES, RSA, and other encryption/decryption capabilities
            - **PointyCastle wrapper**: High-level APIs over the PointyCastle library
            - **Secure random**: Includes secure-random executable
            - **Production-ready**: Used in production applications for encryption needs
            
            Key files:
            - `lib/encrypt.dart` - Main library entry point
            - `lib/src/` - Core encryption implementation
            - `bin/secure-random.dart` - Secure random executable
            
            Release Please has proposed version **${{ steps.version.outputs.version }}** (from ${{ steps.prev_version.outputs.prev_version }}).
            
            ---
            
            ## üéØ YOUR MISSION: Complete Pre-Release Enhancement
            
            Execute these tasks IN ORDER:
            
            ---
            
            ## TASK 0: üî¢ VERSION REVIEW (CRITICAL - DO THIS FIRST!)
            
            ```bash
            git log v${{ steps.prev_version.outputs.prev_version }}..HEAD --oneline 2>/dev/null || git log --oneline -20
            ```
            
            **Version Rules:**
            | Change Type | Version | Examples |
            |-------------|---------|----------|
            | **MAJOR** | X.0.0 | Breaking API changes, removed methods, incompatible changes |
            | **MINOR** | x.Y.0 | New encryption algorithms, new features, new APIs |
            | **PATCH** | x.y.Z | Bug fixes, security patches, performance improvements, docs |
            
            **‚ö†Ô∏è BREAKING CHANGE Rules (IMPORTANT!):**
            
            Only use MAJOR bump for **actual API breaking changes**:
            - ‚úÖ Removing or renaming public methods/classes
            - ‚úÖ Changing method signatures
            - ‚úÖ Incompatible encryption format changes
            
            **NEVER** MAJOR for:
            - ‚ùå Workflow/CI changes
            - ‚ùå Documentation updates
            - ‚ùå Internal refactoring
            - ‚ùå Adding new features (that's MINOR)
            - ‚ùå Security patches (usually PATCH)
            
            **If version is wrong** (e.g., 6.0.0 for docs changes):
            1. Update `.release-please-manifest.json` to correct version
            2. Update `pubspec.yaml` version field
            3. Update CHANGELOG.md version header
            4. Commit: `fix: Adjust version to X.Y.Z (from proposed A.B.C)`
            
            ---
            
            ## TASK 1: üìù ADD RELEASE HIGHLIGHTS
            
            Insert after version header in CHANGELOG.md:
            
            ```markdown
            ### üöÄ Release Highlights
            
            [2-4 sentences about DEVELOPER IMPACT, not implementation details]
            [Focus on: new encryption capabilities, security improvements, API enhancements]
            ```
            
            **‚úÖ GOOD Example:**
            ```markdown
            ### üöÄ Release Highlights
            
            This release adds support for AES-GCM encryption mode, providing authenticated encryption
            with better security guarantees. The update also includes performance improvements for
            large file encryption operations.
            ```
            
            **‚ùå BAD Example:**
            ```markdown
            ### üöÄ Release Highlights
            
            Various improvements and updates. Fixed some bugs and updated dependencies.
            Please update when convenient.
            ```
            
            Commit: `docs: Add AI-enhanced release highlights for v${{ steps.version.outputs.version }}`
            
            ---
            
            ## TASK 2: üìö DOCUMENTATION SYNC
            
            Check if these need updates:
            - `README.md` - Installation instructions, version references, usage examples
            - `CHANGELOG.md` - Ensure all changes are properly documented
            
            **Only update if genuinely needed.** Don't change for the sake of it.
            
            ---
            
            ## TASK 3: üè∑Ô∏è ISSUE MANAGEMENT
            
            ```bash
            gh issue list --repo ${{ github.repository }} --state open --limit 50
            ```
            
            **When to CLOSE an issue:**
            - Commit explicitly says "Fixes #X" or "Closes #X"
            - You can verify the fix by reading code changes
            - Issue description matches what was changed
            
            **When NOT to close:**
            - Partially addressed (comment with progress instead)
            - Not 100% certain it's fixed
            - Security issues needing user verification
            
            **Closing comment format:**
            ```
            üéâ This issue has been addressed in v${{ steps.version.outputs.version }}!
            The fix will be available once the release PR merges.
            ```
            
            ---
            
            ## TASK 4: üí¨ POST PR SUMMARY
            
            ```bash
            gh pr comment ${{ github.event.pull_request.number }} --body "## üîê Release v[VERSION] Ready!
            
            ### Version Review:
            - **Proposed:** ${{ steps.version.outputs.version }}
            - **Final:** [ACTUAL_VERSION] ‚úÖ
            - **Reason:** [Why this version is correct]
            
            ### What Claude Did:
            - [x] Reviewed version appropriateness
            - [x] Added Release Highlights to CHANGELOG.md
            - [x] Reviewed documentation (updates: yes/no)
            - [x] Processed related issues (N found)
            
            ### Security/Crypto Notes:
            [Notes about encryption improvements, security patches, API changes, etc.]
            
            ### Installation (after merge):
            \\\`\\\`\\\`yaml
            dependencies:
              encrypt:
                git:
                  url: https://github.com/pieces-app/encrypt
                  tag_pattern: \"^v\"
                version: ^[VERSION]
            \\\`\\\`\\\`
            
            **Ready to merge!** üéâ
            
            ---
            *ü§ñ Generated by Claude Code Action*"
            ```
            
            ---
            
            ## EXECUTION RULES
            
            1. **Git Setup First:**
               ```bash
               git config user.name "github-actions[bot]"
               git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
               ```
            
            2. **Commit Each Change Separately** with conventional commit messages
            
            3. **Push All Changes:**
               ```bash
               git push origin ${{ github.event.pull_request.head.ref }}
               ```
            
            4. **Be Conservative** - this is a cryptography library used in production
            
            Now execute all tasks in order!
          claude_args: |
            --allowedTools "Read,Edit,Bash(git:*),Bash(gh:*),Bash(cat:*),Bash(head:*),Bash(grep:*)"

      - name: ‚ÑπÔ∏è Already Enhanced Notice
        if: steps.check.outputs.already_enhanced == 'true'
        run: |
          echo "‚ÑπÔ∏è Release PR already enhanced - skipping"

